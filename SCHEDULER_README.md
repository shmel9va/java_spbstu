# Планировщик и асинхронные задачи

## Обзор

Добавлена функциональность планировщика для автоматической проверки просроченных задач и асинхронной обработки уведомлений.

## Новые компоненты

### 1. SchedulerService
- **Интерфейс**: `com.example.lab.service.SchedulerService`
- **Реализация**: `com.example.lab.service.impl.SchedulerServiceImpl`

#### Методы:
- `checkOverdueTasks()` - Планируемый метод (каждые 5 минут) для проверки просроченных задач
- `processOverdueTasksAsync()` - Асинхронный метод для обработки просроченных задач

### 2. Конфигурация асинхронности
- **Класс**: `com.example.lab.config.AsyncConfig`
- Настройка пула потоков для асинхронной обработки

### 3. Исключения
- **Класс**: `com.example.lab.exception.ExternalServiceUnavailableException`
- Для обработки ошибок внешних сервисов (Kafka)

## Настройки

### application.properties
```properties
# Scheduler Configuration
spring.task.scheduling.pool.size=2
spring.task.execution.pool.core-size=2
spring.task.execution.pool.max-size=5
spring.task.execution.pool.queue-capacity=100
```

## API Endpoints

### SchedulerController (`/api/scheduler`)

1. **POST /api/scheduler/check-overdue**
   - Ручной запуск проверки просроченных задач
   - Ответ: "Overdue tasks check initiated"

2. **GET /api/scheduler/overdue**
   - Получение списка просроченных задач
   - Ответ: JSON массив просроченных задач

3. **POST /api/scheduler/process-overdue-async**
   - Ручной запуск асинхронной обработки просроченных задач
   - Ответ: "Async processing of overdue tasks initiated"

## Как это работает

1. **Автоматическая проверка**: Каждые 5 минут (`@Scheduled(fixedRate = 300000)`) запускается проверка просроченных задач
2. **Поиск просроченных задач**: Ищутся незавершенные и неудаленные задачи с `targetDate < now`
3. **Асинхронная обработка**: Для каждой просроченной задачи создается событие "OVERDUE"
4. **Отправка в Kafka**: События отправляются в Kafka для дальнейшей обработки
5. **Создание уведомлений**: Kafka listener создает уведомления пользователям

## Аннотации

- `@EnableScheduling` - Включает поддержку планировщика
- `@EnableAsync` - Включает поддержку асинхронных методов
- `@Scheduled` - Помечает методы для планового выполнения
- `@Async` - Помечает методы для асинхронного выполнения
- `@Transactional` - Обеспечивает транзакционность операций

## Тестирование

Созданы unit тесты в `SchedulerServiceTest`:
- Проверка отправки уведомлений для просроченных задач
- Проверка отсутствия уведомлений при отсутствии просроченных задач
- Проверка вызова асинхронной обработки

## Логирование

Все операции планировщика логируются с использованием SLF4J:
- Информация о найденных просроченных задачах
- Успешная отправка уведомлений
- Ошибки при обработке

## Интеграция с существующей системой

- Использует существующую модель `Task`
- Интегрируется с `TaskEventProducer` для отправки событий
- Совместим с существующими репозиториями
- Использует существующую Kafka инфраструктуру 